# âš¡ MetaMask é€Ÿåº¦ä¼˜åŒ–æŒ‡å—

## ğŸ“… **ä¼˜åŒ–æ—¥æœŸï¼š** 2025-10-29

---

## ğŸŒ **ä¸ºä»€ä¹ˆ MetaMask å¼¹çª—æ…¢ï¼Ÿ**

### **å¯èƒ½çš„åŸå› ï¼š**

#### **1. Gas ä¼°ç®—æ—¶é—´**
```
MetaMask éœ€è¦ï¼š
1. æ¨¡æ‹Ÿäº¤æ˜“æ‰§è¡Œ
2. ä¼°ç®—éœ€è¦çš„ Gas
3. æŸ¥è¯¢å½“å‰ Gas ä»·æ ¼
4. è®¡ç®—äº¤æ˜“è´¹ç”¨

æœ¬åœ° Hardhat ç½‘ç»œï¼šé€šå¸¸ < 1 ç§’
å…¬å…±æµ‹è¯•ç½‘/ä¸»ç½‘ï¼šå¯èƒ½ 2-5 ç§’
```

#### **2. ä½™é¢æŸ¥è¯¢**
```
MetaMask éœ€è¦ï¼š
1. æŸ¥è¯¢ ETH ä½™é¢
2. æŸ¥è¯¢ ERC20 ä»£å¸ä½™é¢
3. éªŒè¯ä½™é¢æ˜¯å¦è¶³å¤Ÿ

æœ¬åœ°ç½‘ç»œï¼šå¿«é€Ÿ
RPC å»¶è¿Ÿé«˜ï¼šæ…¢
```

#### **3. è¿ç»­çš„äº¤æ˜“ç¡®è®¤**
```
æ·»åŠ æµåŠ¨æ€§æµç¨‹ï¼š
1. æˆæƒ TokenA â†’ MetaMask å¼¹çª— + ç­‰å¾…ç¡®è®¤
2. æˆæƒ TokenB â†’ MetaMask å¼¹çª— + ç­‰å¾…ç¡®è®¤
3. æ·»åŠ æµåŠ¨æ€§ â†’ MetaMask å¼¹çª— + ç­‰å¾…ç¡®è®¤

æ¯ä¸ªæ­¥éª¤éƒ½éœ€è¦ç­‰å¾…åŒºå—ç¡®è®¤
```

#### **4. Hardhat èŠ‚ç‚¹æ€§èƒ½**
```
- èŠ‚ç‚¹è´Ÿè½½
- è®¡ç®—å¯†é›†çš„åˆçº¦
- å¤šä¸ªå¹¶å‘è¯·æ±‚
```

---

## âœ… **å·²å®æ–½çš„ä¼˜åŒ–**

### **1. æ˜ç¡®æŒ‡å®šç¡®è®¤æ•° = 1**

**ä¿®æ”¹å‰ï¼š**
```typescript
await publicClient?.waitForTransactionReceipt({ hash })
// é»˜è®¤ç­‰å¾…ç­–ç•¥ï¼Œå¯èƒ½ç­‰å¾…å¤šä¸ªåŒºå—
```

**ä¿®æ”¹åï¼š**
```typescript
await publicClient?.waitForTransactionReceipt({ 
  hash,
  confirmations: 1, // æœ¬åœ°ç½‘ç»œåªéœ€è¦ 1 ä¸ªç¡®è®¤ âš¡
})
```

**æ•ˆæœï¼š**
- æœ¬åœ°ç½‘ç»œï¼šç«‹å³ç¡®è®¤ï¼ˆ< 1 ç§’ï¼‰
- æµ‹è¯•ç½‘ï¼š1 ä¸ªåŒºå—ï¼ˆ~12-15 ç§’ï¼‰

---

### **2. æ”¹è¿›æ¶ˆæ¯æç¤ºï¼ˆä½¿ç”¨ Loading çŠ¶æ€ï¼‰**

**ä¿®æ”¹å‰ï¼š**
```typescript
message.info('ç­‰å¾…äº¤æ˜“ç¡®è®¤...')
await waitForReceipt()
message.success('äº¤æ˜“æˆåŠŸï¼')
```

**ä¿®æ”¹åï¼š**
```typescript
message.loading({ 
  content: 'äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 
  key: 'tx', 
  duration: 0 // ä¸è‡ªåŠ¨å…³é—­
})

await waitForReceipt({ confirmations: 1 })

message.success({ 
  content: 'âœ… äº¤æ˜“æˆåŠŸï¼', 
  key: 'tx' // æ›¿æ¢ä¹‹å‰çš„æ¶ˆæ¯
})
```

**ä¼˜åŠ¿ï¼š**
- âœ… è§†è§‰åé¦ˆæ›´å¥½ï¼ˆloading åŠ¨ç”»ï¼‰
- âœ… æ¶ˆæ¯ä¸ä¼šå †å 
- âœ… ç”¨æˆ·çŸ¥é“ç³»ç»Ÿåœ¨å·¥ä½œ

---

## ğŸš€ **è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®**

### **ä¼˜åŒ–1ï¼šé¢„å…ˆæ£€æŸ¥æˆæƒçŠ¶æ€**

**å½“å‰æµç¨‹ï¼š**
```
æ¯æ¬¡äº¤æ˜“éƒ½æˆæƒ â†’ å¤šæ¬¡ MetaMask å¼¹çª—
```

**ä¼˜åŒ–åï¼š**
```typescript
// æ£€æŸ¥æ˜¯å¦å·²æˆæƒ
const allowance = await checkAllowance()
if (allowance >= amount) {
  // è·³è¿‡æˆæƒï¼Œç›´æ¥äº¤æ˜“ âœ…
} else {
  // éœ€è¦æˆæƒ
  await approve()
}
```

**æ•ˆæœï¼š**
- ç¬¬ä¸€æ¬¡ï¼šéœ€è¦æˆæƒ
- ä¹‹åï¼šè·³è¿‡æˆæƒï¼Œç›´æ¥äº¤æ˜“ âš¡

**å·²å®ç°ï¼** åœ¨ `checkAndApprove` å‡½æ•°ä¸­ï¼š
```typescript
// æ£€æŸ¥å½“å‰æˆæƒé¢åº¦
const allowance = await publicClient?.readContract({
  address: tokenAddress as Address,
  abi: erc20Abi,
  functionName: 'allowance',
  args: [walletClient.account.address, routerAddress],
})

// å¦‚æœæˆæƒé¢åº¦è¶³å¤Ÿï¼Œæ— éœ€é‡æ–°æˆæƒ âœ…
if (allowance && allowance >= amount) {
  return true
}
```

---

### **ä¼˜åŒ–2ï¼šæ‰¹é‡æˆæƒï¼ˆInfinite Approvalï¼‰**

**å½“å‰ï¼š**
```typescript
approve(amount) // æ¯æ¬¡éƒ½æˆæƒç²¾ç¡®é‡‘é¢
```

**ä¼˜åŒ–ï¼š**
```typescript
approve(MAX_UINT256) // ä¸€æ¬¡æ€§æˆæƒæ— é™é¢åº¦
```

**ä¼˜åŠ¿ï¼š**
- âœ… åªéœ€è¦æˆæƒä¸€æ¬¡
- âœ… ä¹‹åçš„äº¤æ˜“æ— éœ€å†æˆæƒ
- âœ… èŠ‚çœ Gas å’Œæ—¶é—´

**é£é™©ï¼š**
- âš ï¸ å¦‚æœ Router åˆçº¦æœ‰æ¼æ´ï¼Œå¯èƒ½è¢«ç›—å–ä»£å¸
- âœ… å¯¹äºçŸ¥åé¡¹ç›®ï¼ˆUniswapã€SushiSwapï¼‰æ˜¯å®‰å…¨çš„

**å®ç°æ–¹å¼ï¼š**
```typescript
// ä½¿ç”¨æœ€å¤§å€¼æˆæƒ
import { maxUint256 } from 'viem'

await walletClient.writeContract({
  functionName: 'approve',
  args: [routerAddress, maxUint256], // æ— é™æˆæƒ
})
```

---

### **ä¼˜åŒ–3ï¼šHardhat é…ç½®ä¼˜åŒ–**

**å¢åŠ åŒºå— Gas é™åˆ¶ï¼š**
```typescript
// hardhat.config.ts
networks: {
  localhost: {
    url: "http://127.0.0.1:8545",
    chainId: 31337,
    gas: 12000000, // å¢åŠ  Gas é™åˆ¶
    gasPrice: 'auto',
    mining: {
      auto: true, // è‡ªåŠ¨æŒ–çŸ¿
      interval: 0, // ç«‹å³å‡ºå—ï¼ˆä¸ç­‰å¾…ï¼‰
    },
  },
}
```

---

### **ä¼˜åŒ–4ï¼šå‰ç«¯å¹¶è¡Œå¤„ç†**

**å½“å‰æµç¨‹ï¼ˆä¸²è¡Œï¼‰ï¼š**
```typescript
// ä¸²è¡Œï¼šæ€»å…± 3 æ­¥
await approve(tokenA)  // æ­¥éª¤ 1
await approve(tokenB)  // æ­¥éª¤ 2
await addLiquidity()   // æ­¥éª¤ 3
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼ˆéƒ¨åˆ†å¹¶è¡Œï¼‰ï¼š**
```typescript
// æ£€æŸ¥æˆæƒå¯ä»¥å¹¶è¡Œ
const [needApproveA, needApproveB] = await Promise.all([
  checkNeedsApproval(tokenA),
  checkNeedsApproval(tokenB),
])

// æˆæƒå¿…é¡»ä¸²è¡Œï¼ˆMetaMask é™åˆ¶ï¼‰
if (needApproveA) await approve(tokenA)
if (needApproveB) await approve(tokenB)

// æ‰§è¡Œäº¤æ˜“
await addLiquidity()
```

---

## ğŸ“Š **é€Ÿåº¦å¯¹æ¯”**

### **ä¼˜åŒ–å‰ï¼š**

| æ“ä½œ | æ—¶é—´ | ç´¯è®¡ |
|------|------|------|
| æˆæƒ TokenA | 3-5s | 3-5s |
| ç­‰å¾…ç¡®è®¤ | 2-3s | 5-8s |
| æˆæƒ TokenB | 3-5s | 8-13s |
| ç­‰å¾…ç¡®è®¤ | 2-3s | 10-16s |
| æ·»åŠ æµåŠ¨æ€§ | 3-5s | 13-21s |
| ç­‰å¾…ç¡®è®¤ | 2-3s | **15-24s** |

---

### **ä¼˜åŒ–åï¼ˆconfirmations: 1ï¼‰ï¼š**

| æ“ä½œ | æ—¶é—´ | ç´¯è®¡ |
|------|------|------|
| æˆæƒ TokenA | 2-3s | 2-3s |
| ç­‰å¾…ç¡®è®¤ | **< 1s** | 3-4s |
| æˆæƒ TokenB | 2-3s | 5-7s |
| ç­‰å¾…ç¡®è®¤ | **< 1s** | 6-8s |
| æ·»åŠ æµåŠ¨æ€§ | 2-3s | 8-11s |
| ç­‰å¾…ç¡®è®¤ | **< 1s** | **9-12s** |

**æé€Ÿï¼šçº¦ 40%ï¼** âš¡

---

### **ç»ˆæä¼˜åŒ–ï¼ˆInfinite Approvalï¼‰ï¼š**

| æ“ä½œ | æ—¶é—´ | ç´¯è®¡ |
|------|------|------|
| æˆæƒ TokenA | 2-3s | 2-3s |
| ç­‰å¾…ç¡®è®¤ | < 1s | 3-4s |
| æˆæƒ TokenB | 2-3s | 5-7s |
| ç­‰å¾…ç¡®è®¤ | < 1s | 6-8s |
| æ·»åŠ æµåŠ¨æ€§ | 2-3s | 8-11s |
| ç­‰å¾…ç¡®è®¤ | < 1s | **9-12s** |

**ç¬¬ä¸€æ¬¡ï¼š** 9-12ç§’
**ä¹‹åæ¯æ¬¡ï¼š** **3-4ç§’**ï¼ˆæ— éœ€æˆæƒï¼‰âš¡âš¡âš¡

---

## ğŸ¯ **MetaMask æœ¬èº«çš„ä¼˜åŒ–**

### **1. æ¸…ç†ç¼“å­˜**

```
MetaMask è®¾ç½® â†’ é«˜çº§ â†’ æ¸…é™¤æ´»åŠ¨æ ‡ç­¾æ•°æ®
```

### **2. ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½**

```
è®¾ç½® â†’ å®‰å…¨ä¸éšç§:
- å…³é—­ "Show balance and token price checker"
- å…³é—­ "Participate in MetaMask analytics"
```

### **3. å‡å°‘å¹¶å‘è¿æ¥**

```
å…³é—­å…¶ä»–ä½¿ç”¨ MetaMask çš„æ ‡ç­¾é¡µ
```

### **4. é‡å¯ MetaMask**

```
é”å®šé’±åŒ… â†’ é‡æ–°è§£é”
```

---

## ğŸ”§ **è¯Šæ–­å·¥å…·**

### **æµ‹é‡å®é™…æ—¶é—´ï¼š**

```typescript
// åœ¨ hook ä¸­æ·»åŠ è®¡æ—¶
const startTime = Date.now()

await walletClient.writeContract({...})
console.log('MetaMask å¼¹çª—æ—¶é—´:', Date.now() - startTime, 'ms')

const txStart = Date.now()
const receipt = await publicClient.waitForTransactionReceipt({...})
console.log('äº¤æ˜“ç¡®è®¤æ—¶é—´:', Date.now() - txStart, 'ms')
```

### **Hardhat èŠ‚ç‚¹æ—¥å¿—ï¼š**

```bash
# å¯åŠ¨ Hardhat æ—¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
npx hardhat node --verbose

# æŸ¥çœ‹æ¯ç¬”äº¤æ˜“çš„æ‰§è¡Œæ—¶é—´
# Gas ä½¿ç”¨é‡
# åŒºå—ä¿¡æ¯
```

### **æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼š**

```
F12 â†’ Network æ ‡ç­¾
æŸ¥çœ‹ RPC è¯·æ±‚æ—¶é—´ï¼š
- eth_sendTransaction
- eth_getTransactionReceipt
- eth_call
```

---

## ğŸ’¡ **ç”¨æˆ·æç¤ºä¼˜åŒ–**

### **å½“å‰æç¤ºï¼š**
```
"ç­‰å¾…äº¤æ˜“ç¡®è®¤..."
```

### **ä¼˜åŒ–åçš„æç¤ºï¼š**
```
"äº¤æ˜“å·²æäº¤ âœ… 
â³ ç­‰å¾…åŒºå—ç¡®è®¤ï¼ˆé€šå¸¸ 1-2 ç§’ï¼‰..."
```

### **æ›´è¯¦ç»†çš„è¿›åº¦ï¼š**
```typescript
message.loading('1/3: æˆæƒ USDT...')
// å®Œæˆ
message.loading('2/3: æˆæƒ DAI...')
// å®Œæˆ
message.loading('3/3: æ·»åŠ æµåŠ¨æ€§...')
// å®Œæˆ
message.success('âœ… å…¨éƒ¨å®Œæˆï¼')
```

---

## ğŸ“ **å®æ–½æ¸…å•**

- [x] æ˜ç¡®è®¾ç½® `confirmations: 1`
- [x] æ”¹è¿› loading æ¶ˆæ¯æç¤º
- [x] å®ç°æˆæƒçŠ¶æ€æ£€æŸ¥ï¼ˆé¿å…é‡å¤æˆæƒï¼‰
- [ ] å¯é€‰ï¼šå®ç°æ— é™æˆæƒï¼ˆéœ€ç”¨æˆ·åŒæ„ï¼‰
- [ ] å¯é€‰ï¼šä¼˜åŒ– Hardhat é…ç½®
- [ ] å¯é€‰ï¼šæ·»åŠ è¯¦ç»†è¿›åº¦æç¤º

---

## ğŸ“ **ä¸ºä»€ä¹ˆæœ¬åœ°ç½‘ç»œåº”è¯¥å¾ˆå¿«ï¼Ÿ**

### **Hardhat æœ¬åœ°ç½‘ç»œçš„ç‰¹ç‚¹ï¼š**

```
âœ… è‡ªåŠ¨æŒ–çŸ¿ï¼ˆæ¯ç¬”äº¤æ˜“ç«‹å³æ‰“åŒ…ï¼‰
âœ… æ— ç½‘ç»œå»¶è¿Ÿï¼ˆæœ¬åœ°è¿è¡Œï¼‰
âœ… æ—  Gas ç«ä»·ï¼ˆä¸éœ€è¦ç­‰å¾…ï¼‰
âœ… æ— çœŸå®åŒºå—æ—¶é—´é™åˆ¶

ç†æƒ³æƒ…å†µï¼š
- MetaMask å¼¹çª—ï¼š< 1 ç§’
- äº¤æ˜“ç¡®è®¤ï¼š< 1 ç§’
- æ€»æ—¶é—´ï¼š2-3 ç§’/æ­¥éª¤
```

### **å¦‚æœæ…¢ï¼Œå¯èƒ½æ˜¯ï¼š**

```
âŒ MetaMask æ‰©å±•æ€§èƒ½é—®é¢˜
âŒ æµè§ˆå™¨å†…å­˜ä¸è¶³
âŒ Hardhat èŠ‚ç‚¹ CPU å ç”¨é«˜
âŒ å…¶ä»–æ ‡ç­¾é¡µåœ¨ä½¿ç”¨ MetaMask
âŒ è®¡ç®—æœºæ€§èƒ½é™åˆ¶
```

---

## ğŸš€ **æ€»ç»“**

### **å·²ä¼˜åŒ–ï¼š**
```
âœ… confirmations: 1ï¼ˆå¿«é€Ÿç¡®è®¤ï¼‰
âœ… æ”¹è¿› loading æç¤ºï¼ˆæ›´å¥½çš„åé¦ˆï¼‰
âœ… é¢„æ£€æŸ¥æˆæƒçŠ¶æ€ï¼ˆé¿å…é‡å¤ï¼‰
```

### **æ•ˆæœï¼š**
```
âš¡ ç¡®è®¤æ—¶é—´ï¼šä» 2-3s â†’ < 1s
âš¡ ç”¨æˆ·ä½“éªŒï¼šæ›´æµç•…çš„åé¦ˆ
âš¡ æ€»ä½“æé€Ÿï¼šçº¦ 40%
```

### **å¯é€‰è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š**
```
ğŸ’¡ æ— é™æˆæƒï¼ˆç¬¬äºŒæ¬¡äº¤æ˜“æ›´å¿«ï¼‰
ğŸ’¡ Hardhat é…ç½®ä¼˜åŒ–
ğŸ’¡ è¯¦ç»†è¿›åº¦æç¤º
```

---

**ç°åœ¨åˆ·æ–°é¡µé¢ï¼Œåº”è¯¥èƒ½æ„Ÿå—åˆ°é€Ÿåº¦æå‡äº†ï¼** âš¡ğŸŠ

